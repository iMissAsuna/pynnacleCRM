{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} {# Load your custom filters for get_item, replace etc. #}

{% block title %}{{ property.name }} Details{% endblock %}

{% block content %}
<div class="container py-5">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 fw-bold mb-0 text-primary">{{ property.name }}</h1>
        <a href="{% url 'properties_list' %}" class="btn btn-outline-secondary d-flex align-items-center rounded-pill">
            <i class="bi bi-arrow-left-circle me-2"></i>
            Back to Properties
        </a>
    </header>

    <div class="card shadow-lg border-0 rounded-4 mb-4">
        <div class="card-body p-4">
            <h5 class="card-title fw-bold text-dark mb-3">Property Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Address:</strong> {{ property.address }}, {{ property.city }}, {{ property.postcode }}</p>
                    <p class="mb-1"><strong>Type:</strong> {{ property.get_property_type_display }}</p>
                    <p class="mb-1"><strong>Units:</strong> {{ property.number_of_units }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="{% url 'edit_property' property.pk %}" class="btn btn-primary btn-sm rounded-pill">
                        <i class="bi bi-pencil me-2"></i>Edit Property
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Existing Tabs for Documents (NOT including Tenants) #}
    <ul class="nav nav-tabs nav-fill mb-4" id="propertyDocumentsTabs" role="tablist">
        {% for tab_slug, tab_details in tab_data.items %}
        <li class="nav-item" role="presentation">
            {# CRITICAL FIX: Removed onclick. Rely solely on href for Django's URL routing. #}
            <a class="nav-link {% if tab_slug == active_tab %}active{% endif %}" id="{{ tab_slug }}-tab" 
               href="{% url 'property_detail' property.pk tab_slug %}" role="tab" 
               aria-controls="{{ tab_slug }}-pane" aria-selected="{% if tab_slug == active_tab %}true{% else %}false{% endif %}">
                {{ tab_details.human_name }} 
                {% if tab_details.count > 0 %}
                    <span class="badge bg-secondary ms-1">{{ tab_details.count }}</span>
                {% endif %}
            </a>
        </li>
        {% endfor %}
    </ul>

    {# Tab Content for Document Tabs #}
    <div class="tab-content" id="propertyDocumentsTabsContent">
        {% for tab_slug, tab_details in tab_data.items %}
        {# Only render the tab-pane content if this is the active tab OR if it's the initial load #}
        {# This ensures only the relevant tab's content is processed and avoids unnecessary form rendering for inactive tabs #}
        <div class="tab-pane fade {% if tab_slug == active_tab %}show active{% endif %}" id="{{ tab_slug }}-pane" role="tabpanel" aria-labelledby="{{ tab_slug }}-tab">
            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-bold text-dark mb-3">{{ tab_details.human_name }} Documents</h5>
                    
                    {# Current folder path (if navigating subfolders within this tab) #}
                    {# Display only if this tab is active AND active_display_folder is relevant to this tab #}
                    {% if tab_slug == active_tab %}
                        {% if active_display_folder and active_display_folder.parent and active_display_folder.get_root_folder.name == tab_details.human_name %}
                            <p class="text-muted small mb-3">
                                Current Path: 
                                {% for ancestor in active_display_folder.get_ancestors %}
                                    {% if ancestor.parent %}<a href="{% url 'property_detail' property.pk active_tab %}?folder_pk={{ ancestor.pk }}" class="text-decoration-none">{{ ancestor.name }}</a> / {% else %}{{ ancestor.name }} / {% endif %}
                                {% endfor %}
                                <strong>{{ active_display_folder.name }}</strong>
                                {# Link back up to parent folder #}
                                {% if active_display_folder.parent %}
                                    <a href="{% url 'property_detail' property.pk active_tab %}{% if active_display_folder.parent.parent %}/?folder_pk={{ active_display_folder.parent.pk }}{% endif %}" class="ms-2 btn btn-sm btn-outline-info rounded-pill">
                                        <i class="bi bi-arrow-up-left"></i> Up
                                    </a>
                                {% endif %}
                            </p>
                        {% elif active_display_folder and not active_display_folder.parent and active_display_folder.name == tab_details.human_name and current_folder_pk %}
                            {# If currently at root folder but via folder_pk in URL, show 'Up' to reset to root view #}
                             <p class="text-muted small mb-3">
                                 Current Path: <strong>{{ active_display_folder.name }}</strong>
                                 <a href="{% url 'property_detail' property.pk active_tab %}" class="ms-2 btn btn-sm btn-outline-info rounded-pill">
                                     <i class="bi bi-arrow-up-left"></i> Up (to root)
                                 </a>
                             </p>
                        {% endif %}
                    {% endif %}

                    {# Form to upload documents to the active folder #}
                    <form method="post" enctype="multipart/form-data" class="mb-4">
                        {% csrf_token %}
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <label for="{{ document_form.file.id_for_label }}" class="form-label">Upload New Document</label>
                                {{ document_form.file }}
                                {% if document_form.file.errors %}
                                    <div class="text-danger small mt-1">{{ document_form.file.errors }}</div>
                                {% endif %}
                                {# Ensure folder ID is passed for active_display_folder, not just tab's root folder #}
                                <input type="hidden" name="folder" value="{{ active_display_folder.pk }}">
                            </div>
                            <div class="col-md-4 d-grid">
                                <button type="submit" class="btn btn-success rounded-pill">
                                    <i class="bi bi-upload me-2"></i>Upload File
                                </button>
                            </div>
                        </div>
                    </form>

                    <hr class="my-4">

                    {# Display Existing Documents and Subfolders #}
                    <h6 class="fw-bold mb-3">Contents:</h6>
                    {% if all_subfolders or documents_in_folder %}
                    <ul class="list-group list-group-flush border rounded-3 overflow-hidden">
                        {# Subfolders #}
                        {% for folder in all_subfolders %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-folder me-3 fs-5 text-warning"></i>
                                <span class="fw-bold">{{ folder.name }}</span>
                                {% if folder.get_document_count > 0 %}
                                    <span class="badge bg-info ms-2">{{ folder.get_document_count }}</span>
                                {% endif %}
                            </div>
                            <div class="d-flex">
                                <a href="{% url 'property_detail' property.pk active_tab %}?folder_pk={{ folder.pk }}" class="btn btn-sm btn-outline-secondary rounded-pill me-1" title="Open Folder">
                                    <i class="bi bi-folder-fill"></i>
                                </a>
                                <form method="post" action="{% url 'delete_folder' folder.pk %}" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this folder and ALL its contents? This cannot be undone.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Delete Folder">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}

                        {# Documents directly in this folder #}
                        {% for document in documents_in_folder %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark-text me-3 fs-5 text-muted"></i>
                                <a href="{{ document.file.url }}" target="_blank" class="text-decoration-none text-dark fw-bold">{{ document.file.name|split:"/"|last }}</a>
                                <span class="text-muted ms-2 small"> 
                                    {% if document.display_size %}
                                        ({{ document.display_size }} KB)
                                    {% else %}
                                        (N/A)
                                    {% endif %}
                                </span>
                            </div>
                            <div class="d-flex">
                                <a href="{{ document.file.url }}" target="_blank" class="btn btn-sm btn-outline-info rounded-pill me-1" title="View Document">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <form method="post" action="{% url 'delete_document' document.pk %}" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this document?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Delete Document">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="alert alert-info border-0 rounded-3 shadow-sm text-center" role="alert">
                        <h5 class="alert-heading">No documents or subfolders found.</h5>
                        <p>Use the "Upload New Document" button to add files, or create subfolders to organize.</p>
                    </div>
                    {% endif %}

                    <hr class="my-4">

                    {# Add Subfolder Form for document tabs #}
                    <h6 class="fw-bold mb-3">Add New Subfolder</h6>
                    {# FIXED: Use 'add_subfolder' URL pattern and pass parent_folder_pk directly in the path #}
                    <form method="post" action="{% url 'add_subfolder' property.pk active_tab active_display_folder.pk %}" class="mb-4">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="name" class="form-control rounded-start-pill" placeholder="Subfolder Name" required>
                            <button type="submit" class="btn btn-outline-primary rounded-end-pill">
                                <i class="bi bi-folder-plus me-2"></i>Create Subfolder
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# --- NEW: Separate Section for Tenant Details & Documents --- #}
    <hr class="my-5">

    <div class="mb-4">
        <h2 class="h4 fw-bold mb-0 text-dark">Tenant Details & Documents</h2>
    </div>

    {# Tenant History and Add Tenant Form #}
    <div class="card shadow-lg border-0 rounded-4 mb-4">
        <div class="card-body p-4">
            <h5 class="fw-bold text-dark mb-3">Tenant History</h5>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-primary">
                        <div class="card-header bg-primary text-white fw-bold rounded-top-2">
                            <i class="bi bi-people-fill me-2"></i> Current Tenants ({{ current_tenants|length }})
                        </div>
                        <div class="card-body p-0">
                            {% if current_tenants %}
                                <ul class="list-group list-group-flush">
                                    {% for rel in current_tenants %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <a href="{% url 'record' rel.tenant.pk %}" class="text-decoration-none text-primary fw-bold">
                                                {{ rel.tenant.full_name }}
                                            </a>
                                            <br>
                                            <small class="text-muted">Move-in: {{ rel.move_in_date|date:"M d, Y" }}</small>
                                        </div>
                                        <form method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to remove {{ rel.tenant.full_name }} from this property record? This does NOT delete the tenant record itself.');">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_tenant_relationship" value="true">
                                            <input type="hidden" name="relationship_id" value="{{ rel.pk }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Remove Tenant">
                                                <i class="bi bi-person-x"></i>
                                            </button>
                                        </form>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <div class="alert alert-info m-3 text-center" role="alert">
                                    No current tenants recorded for this property.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-secondary">
                        <div class="card-header bg-secondary text-white fw-bold rounded-top-2">
                            <i class="bi bi-person-x-fill me-2"></i> Past Tenants ({{ past_tenants|length }})
                        </div>
                        <div class="card-body p-0">
                            {% if past_tenants %}
                                <ul class="list-group list-group-flush">
                                    {% for rel in past_tenants %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <a href="{% url 'record' rel.tenant.pk %}" class="text-decoration-none text-dark fw-bold">
                                                {{ rel.tenant.full_name }}
                                            </a>
                                            <br>
                                            <small class="text-muted">
                                                {{ rel.move_in_date|date:"M d, Y" }} - 
                                                {% if rel.move_out_date %}{{ rel.move_out_date|date:"M d, Y" }}{% else %}Present{% endif %}
                                            </small>
                                        </div>
                                        <form method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to remove {{ rel.tenant.full_name }} from this property record? This does NOT delete the tenant record itself.');">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_tenant_relationship" value="true">
                                            <input type="hidden" name="relationship_id" value="{{ rel.pk }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Remove Tenant">
                                                <i class="bi bi-person-x"></i>
                                            </button>
                                        </form>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <div class="alert alert-info m-3 text-center" role="alert">
                                    No past tenants recorded for this property.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <h5 class="fw-bold text-dark mb-3">Add Tenant to Property</h5>
            <form method="POST">
                {% csrf_token %}
                {{ tenant_relationship_form.media }} {# Essential for Select2 #}
                
                <input type="hidden" name="add_tenant_relationship" value="true">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ tenant_relationship_form.tenant.id_for_label }}" class="form-label fw-bold">Select Tenant</label>
                        {{ tenant_relationship_form.tenant }}
                        {% if tenant_relationship_form.tenant.errors %}
                            <div class="text-danger small mt-1">{{ tenant_relationship_form.tenant.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ tenant_relationship_form.move_in_date.id_for_label }}" class="form-label fw-bold">Move-in Date</label>
                        {{ tenant_relationship_form.move_in_date }}
                        {% if tenant_relationship_form.move_in_date.errors %}
                            <div class="text-danger small mt-1">{{ tenant_relationship_form.move_in_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ tenant_relationship_form.move_out_date.id_for_label }}" class="form-label fw-bold">Move-out Date (Optional)</label>
                        {{ tenant_relationship_form.move_out_date }}
                        {% if tenant_relationship_form.move_out_date.errors %}
                            <div class="text-danger small mt-1">{{ tenant_relationship_form.move_out_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                        <i class="bi bi-person-plus me-2"></i>Add Tenant Relationship
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# --- NEW: Separate Section for Tenant Documents Folder Structure --- #}
    <hr class="my-5">

    <div class="card shadow-lg border-0 rounded-4 mb-4">
        <div class="card-body p-4">
            <h5 class="fw-bold text-dark mb-3">Tenant Specific Files</h5>
            
            {# Current folder path for Tenant Documents (if navigating subfolders) #}
            {# Check if the active_tab is TENANT_DOCS_FOLDER_SLUG to show this section's path #}
            {% if active_tab == TENANT_DOCS_FOLDER_SLUG %}
                {% if active_display_folder and active_display_folder.parent %}
                    <p class="text-muted small mb-3">
                        Current Path: 
                        {% for ancestor in active_display_folder.get_ancestors %}
                            {% if ancestor.pk != tenant_docs_root_folder.pk %}<a href="{% url 'property_detail' property.pk TENANT_DOCS_FOLDER_SLUG %}?folder_pk={{ ancestor.pk }}" class="text-decoration-none">{{ ancestor.name }}</a> / {% else %}{{ ancestor.name }} / {% endif %}
                        {% endfor %}
                        <strong>{{ active_display_folder.name }}</strong>
                        <a href="{% url 'property_detail' property.pk TENANT_DOCS_FOLDER_SLUG %}{% if active_display_folder.parent and active_display_folder.parent.pk != tenant_docs_root_folder.pk %}/?folder_pk={{ active_display_folder.parent.pk }}{% endif %}" class="ms-2 btn btn-sm btn-outline-info rounded-pill">
                            <i class="bi bi-arrow-up-left"></i> Up
                        </a>
                    </p>
                {% elif active_display_folder == tenant_docs_root_folder and current_folder_pk %} {# If at root via specific PK, allow 'Up' to reset #}
                    <p class="text-muted small mb-3">
                        Current Path: <strong>{{ tenant_docs_root_folder.name }}</strong>
                        <a href="{% url 'property_detail' property.pk TENANT_DOCS_FOLDER_SLUG %}" class="ms-2 btn btn-sm btn-outline-info rounded-pill">
                            <i class="bi bi-arrow-up-left"></i> Up (to root)
                        </a>
                    </p>
                {% endif %}


                {# Form to upload documents to the tenant documents folder #}
                <form method="post" enctype="multipart/form-data" class="mb-4">
                    {% csrf_token %}
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="{{ document_form.file.id_for_label }}" class="form-label">Upload New Document for Tenants</label>
                            {{ document_form.file }}
                            {% if document_form.file.errors %}
                                <div class="text-danger small mt-1">{{ document_form.file.errors }}</div>
                            {% endif %}
                            <input type="hidden" name="folder" value="{{ active_display_folder.pk }}">
                        </div>
                        <div class="col-md-4 d-grid">
                            <button type="submit" class="btn btn-success rounded-pill">
                                <i class="bi bi-upload me-2"></i>Upload Tenant File
                            </button>
                        </div>
                    </div>
                </form>

                <hr class="my-4">

                {# Display Existing Documents and Subfolders for Tenant Documents #}
                <h6 class="fw-bold mb-3">Contents:</h6>
                {% if all_subfolders or documents_in_folder %}
                <ul class="list-group list-group-flush border rounded-3 overflow-hidden">
                    {# Subfolders #}
                    {% for folder in all_subfolders %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-folder me-3 fs-5 text-warning"></i>
                            <span class="fw-bold">{{ folder.name }}</span>
                            {% if folder.get_document_count > 0 %}
                                <span class="badge bg-info ms-2">{{ folder.get_document_count }}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex">
                            <a href="{% url 'property_detail' property.pk TENANT_DOCS_FOLDER_SLUG %}?folder_pk={{ folder.pk }}" class="btn btn-sm btn-outline-secondary rounded-pill me-1" title="Open Folder">
                                <i class="bi bi-folder-fill"></i>
                            </a>
                            <form method="post" action="{% url 'delete_folder' folder.pk %}" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this folder and ALL its contents? This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Delete Folder">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endfor %}

                    {# Documents directly in this folder #}
                    {% for document in documents_in_folder %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-text me-3 fs-5 text-muted"></i>
                            <a href="{{ document.file.url }}" target="_blank" class="text-decoration-none text-dark fw-bold">{{ document.file.name|split:"/"|last }}</a>
                            <span class="text-muted ms-2 small">
                                {% if document.display_size %}
                                    ({{ document.display_size }} KB)
                                {% else %}
                                    (N/A)
                                {% endif %}
                            </span>
                        </div>
                        <div class="d-flex">
                            <a href="{{ document.file.url }}" target="_blank" class="btn btn-sm btn-outline-info rounded-pill me-1" title="View Document">
                                <i class="bi bi-eye"></i>
                            </a>
                            <form method="post" action="{% url 'delete_document' document.pk %}" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this document?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Delete Document">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-info border-0 rounded-3 shadow-sm text-center" role="alert">
                    <h5 class="alert-heading">No tenant documents or subfolders found.</h5>
                    <p>Use the "Upload Tenant File" button to add files, or create subfolders to organize.</p>
                </div>
                {% endif %}

                <hr class="my-4">

                {# Add Subfolder Form for Tenant Documents #}
                <h6 class="fw-bold mb-3">Add New Subfolder to Tenant Documents</h6>
                {# FIXED: Use 'add_subfolder' URL pattern and pass parent_folder_pk directly in the path #}
                <form method="post" action="{% url 'add_subfolder' property.pk TENANT_DOCS_FOLDER_SLUG active_display_folder.pk %}" class="mb-4">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" name="name" class="form-control rounded-start-pill" placeholder="Subfolder Name" required>
                        <button type="submit" class="btn btn-outline-primary rounded-end-pill">
                            <i class="bi bi-folder-plus me-2"></i>Create Subfolder
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="alert alert-warning border-0 rounded-3 shadow-sm text-center" role="alert">
                    <h5 class="alert-heading">Viewing documents from another section.</h5>
                    <p>This section is for Tenant Specific Files. To manage documents here, please ensure you are viewing the 'Tenant Documents' content.</p>
                    <a href="{% url 'property_detail' property.pk TENANT_DOCS_FOLDER_SLUG %}" class="btn btn-primary rounded-pill mt-3">Go to Tenant Documents</a>
                </div>
            {% endif %}

        </div>
    </div>

</div>
{% endblock %}