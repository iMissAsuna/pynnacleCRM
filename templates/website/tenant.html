{% extends 'base.html' %} {% block content %}
<div class="container mt-4">
  <div class="card shadow rounded mb-4">
    <div
      class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
    >
      <h3 class="mb-0">Tenant Details</h3>
      {% if edit_mode %}
      <form
        method="POST"
        action="{% url 'record' record.pk %}"
        class="d-inline"
      >
        {% csrf_token %}
        <button type="submit" name="cancel_edit" class="btn btn-secondary btn-sm">Cancel</button>
      </form>
      {% else %}
      <form
        method="POST"
        action="{% url 'record' record.pk %}"
        class="d-inline"
      >
        {% csrf_token %}
        <input type="hidden" name="edit_mode" value="true" />
        <button type="submit" class="btn btn-primary btn-sm">Edit</button>
      </form>
      {% endif %}
    </div>

    <div class="card-body">
      {% if edit_mode %}
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %} {{ form.non_field_errors }}

        <table class="table table-striped table-hover">
          <tbody>
            {% for field in form %}
            <tr>
              <th style="width: 25%">{{ field.label_tag }}</th>
              <td>{{ field.errors }} {{ field }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <button type="submit" name="save_details" class="btn btn-success">
          Save
        </button>
      </form>
      {% else %}
      <table class="table table-striped table-hover">
        <tbody>
          <tr>
            <th style="width: 25%">Name</th>
            <td>{{ record.first_name }} {{ record.last_name }}</td>
          </tr>
          <tr>
            <th>Phone</th>
            <td>{{ record.phone }}</td>
          </tr>
          <tr>
            <th>Email</th>
            <td>{{ record.email }}</td>
          </tr>
          <tr>
            <th>Address</th>
            <td>{{ record.address }}</td>
          </tr>
          <tr>
            <th>Postcode</th>
            <td>{{ record.postcode }}</td>
          </tr>
          <tr>
            <th>Next of Kin</th>
            <td>{{ record.next_of_kin }}</td>
          </tr>
          <tr>
            <th>Move-in Date</th>
            <td>{{ record.move_in_date }}</td>
          </tr>
          <tr>
            <th>Key Collected</th>
            <td>{{ record.key_collection }}</td>
          </tr>
          <tr>
            <th>Move-out Date</th>
            <td>{{ record.move_out_date }}</td>
          </tr>
          <tr>
            <th>Key Dropped</th>
            <td>{{ record.key_drop_off }}</td>
          </tr>
          <tr>
            <th>Current Residence</th>
            <td>{{ record.current_residence }}</td>
          </tr>
          <tr>
            <th>Occupancy</th>
            <td>{{ record.occupancy_status }}</td>
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>

  <div class="card shadow rounded mb-4">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" id="imageTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="move-in-tab"
            data-bs-toggle="tab"
            data-bs-target="#move-in"
            type="button"
            role="tab"
            aria-controls="move-in"
            aria-selected="true"
          >
            üì∏ Routine Inspection
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="move-out-tab"
            data-bs-toggle="tab"
            data-bs-target="#move-out"
            type="button"
            role="tab"
            aria-controls="move-out"
            aria-selected="false"
          >
            üì∏ Check-out Photos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="id-photo-tab"
            data-bs-toggle="tab"
            data-bs-target="#id-photo"
            type="button"
            role="tab"
            aria-controls="id-photo"
            aria-selected="false"
          >
            üÜî ID Documents
          </button>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content" id="imageTabsContent">
        <div
          class="tab-pane fade show active"
          id="move-in"
          role="tabpanel"
          aria-labelledby="move-in-tab"
        >
          {% if images|length == 0 %}
          <p class="text-muted">No move-in images available.</p>
          {% else %}
          <div class="row g-3">
            {% for image in images %} {% if image.category == "move_in" %}
            <div class="col-lg-3 col-md-4 col-sm-6 position-relative">
              <div class="card h-100 shadow-sm">
                <img
                  src="{{ image.image.url }}"
                  class="card-img-top rounded"
                  alt="Move-in Photo"
                />
                {% if edit_mode %}
                <div class="card-body p-2 text-end">
                  <form
                    method="POST"
                    action="{% url 'delete_image' image.id %}"
                    on-submit="return confirm('Are you sure you want to delete this image?');"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">
                      Delete
                    </button>
                  </form>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %} {% empty %}
            <p class="text-muted">No move-in images available.</p>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div
          class="tab-pane fade"
          id="move-out"
          role="tabpanel"
          aria-labelledby="move-out-tab"
        >
          {% if images|length == 0 %}
          <p class="text-muted">No move-out images available.</p>
          {% else %}
          <div class="row g-3">
            {% for image in images %} {% if image.category == "move_out" %}
            <div class="col-lg-3 col-md-4 col-sm-6 position-relative">
              <div class="card h-100 shadow-sm">
                <img
                  src="{{ image.image.url }}"
                  class="card-img-top rounded"
                  alt="Move-out Photo"
                />
                {% if edit_mode %}
                <div class="card-body p-2 text-end">
                  <form
                    method="POST"
                    action="{% url 'delete_image' image.id %}"
                    on-submit="return confirm('Are you sure you want to delete this image?');"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">
                      Delete
                    </button>
                  </form>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %} {% empty %}
            <p class="text-muted">No move-out images available.</p>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div
          class="tab-pane fade"
          id="id-photo"
          role="tabpanel"
          aria-labelledby="id-photo-tab"
        >
          {% if images|length == 0 %}
          <p class="text-muted">No ID documents available.</p>
          {% else %}
          <div class="row g-3">
            {% for image in images %} {% if image.category == "id_photo" %}
            <div class="col-lg-3 col-md-4 col-sm-6 position-relative">
              <div class="card h-100 shadow-sm">
                <img
                  src="{{ image.image.url }}"
                  class="card-img-top rounded"
                  alt="ID Document"
                />
                {% if edit_mode %}
                <div class="card-body p-2 text-end">
                  <form
                    method="POST"
                    action="{% url 'delete_image' image.id %}"
                    on-submit="return confirm('Are you sure you want to delete this image?');"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">
                      Delete
                    </button>
                  </form>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %} {% empty %}
            <p class="text-muted">No ID documents available.</p>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      {% if edit_mode %}
      <div class="mt-4 border-top pt-3">
        <h5>Add New Image</h5>
        <form
          method="POST"
          action="{% url 'record' record.pk %}"
          enctype="multipart/form-data"
          class="row g-3 align-items-center"
        >
          {% csrf_token %}
          <input type="hidden" name="edit_mode" value="true" />
          <div class="col-md-6 col-lg-4">
            {{ image_form.image.label_tag }}
            {{ image_form.image }}
            <p class="text-danger">{{ image_form.image.errors }}</p>
          </div>
          <div class="col-md-4 col-lg-3">
            {{ image_form.category.label_tag }}
            {{ image_form.category }}
            <p class="text-danger">{{ image_form.category.errors }}</p>
          </div>
          <div class="col-md-2 col-lg-2 d-grid">
            <button type="submit" name="upload_image" class="btn btn-primary">
              Upload
            </button>
          </div>
        </form>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="mb-5">
    <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back to Home</a>
  </div>
</div>

<script>
  // Replacing window.confirm() with a custom modal or alert, as window.confirm() might not work in some embedded environments.
  function showConfirmModal(message, callback) {
    const isConfirmed = window.confirm(message);
    if (isConfirmed) {
      callback();
    }
  }

  var deleteForms = document.querySelectorAll('form[on-submit]');
  deleteForms.forEach(form => {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      showConfirmModal('Are you sure you want to delete this image?', () => {
        form.submit();
      });
    });
  });

  var triggerTabList = [].slice.call(
    document.querySelectorAll("#imageTabs button")
  );
  triggerTabList.forEach(function (triggerEl) {
    var tabTrigger = new bootstrap.Tab(triggerEl);

    triggerEl.addEventListener("click", function (event) {
      event.preventDefault();
      tabTrigger.show();
    });
  });
</script>

{% endblock %}
